
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Behavior Trees #2 | My Little Peaceful Grove of Regret and Shame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="adnzzzzZ">
    
    <meta name="description" content="The previous part of the tutorial is here and it went over the basics of behavior trees as well as their implementation.On this part we’re going to im">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="adnzzzzZ" />
    <meta name="twitter:title" content="Behavior Trees #2 | My Little Peaceful Grove of Regret and Shame" />
      
    
    
    <link rel="alternate" href="/atom.xml" title="My Little Peaceful Grove of Regret and Shame" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
            <!--
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="My Little Peaceful Grove of Regret and Shame" title="My Little Peaceful Grove of Regret and Shame"/></a>
			</div>
            -->
			
            
            <div id="imglogo">
                <div class="author"></div>
            </div>
            
            <!--
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="My Little Peaceful Grove of Regret and Shame">My Little Peaceful Grove of Regret and Shame</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
            -->
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:psychoky.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/17/behavior-trees-number-2/" title="Behavior Trees #2" itemprop="url">Behavior Trees #2</a>
  </h1>
  <p class="article-author">by
    
      <a href="http://psychoky.me" title="adnzzzzZ">adnzzzzZ</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-17T06:46:00.000Z" itemprop="datePublished">Aug 17 2014</time>
    Updated:<time datetime="2015-01-09T03:45:48.000Z" itemprop="dateModified">Jan 9 2015</time>
    
  </p>
</header>

	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Wander"><span class="toc-number">1.</span> <span class="toc-text">Wander</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TK_Practice"><span class="toc-number">2.</span> <span class="toc-text">TK Practice</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Talking_to_Friends"><span class="toc-number">3.</span> <span class="toc-text">Talking to Friends</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Storing_Subtrees"><span class="toc-number">4.</span> <span class="toc-text">Storing Subtrees</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Talking_to_Friends-1"><span class="toc-number">5.</span> <span class="toc-text">Talking to Friends</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Suspicious"><span class="toc-number">6.</span> <span class="toc-text">Suspicious</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Active_Selector"><span class="toc-number">7.</span> <span class="toc-text">Active Selector</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Threatened"><span class="toc-number">8.</span> <span class="toc-text">Threatened</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#END"><span class="toc-number">9.</span> <span class="toc-text">END</span></a></li></ol>
		</div>
		
		<p>The previous part of the tutorial is <a href="">here</a> and it went over the basics of behavior trees as well as their implementation.<br>On this part we’re going to implement the behavior for an enemy. The behavior is actually quite simple from a player/viewer<br>standpoint, but it’s a nice way to introduce most concepts behind behavior trees.</p>
<p>The enemy is going to have three (3) main modes of behaving:</p>
<ul>
<li>Idle</li>
<li>Suspicious</li>
<li>Threatened</li>
</ul>
<p>In the idle mode the enemy will be able to either: wander around its spawn point, talk to another enemy or practice his TK<br>(telekinesis) on a nearby object.  The suspicious mode is triggered whenever the player gets close enough to an enemy. When it is<br>triggered the enemy spawns a question mark above his head and turns towards the player while doing nothing. If the player leaves<br>this trigger area then the enemy goes back to the idle mode, otherwise he stays here.  The threatened mode happens when the player<br>gets really really close to the enemy, in which case the enemy will spawn an angry face above his head, chase the player around and<br>attempt to hit him.</p>
<p>[gif]</p>
<h1 id="Wander">Wander</h1>
<p>Using the <em>findWanderPoint</em> and <em>moveToPoint</em> actions from the last article, we can start building the idle <em>wander</em> behavior.<br>A small addition to that particular sequence is adding an action that makes the entity wait around for a few seconds before choosing<br>the next point, otherwise he moves around too much.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">wait = Action:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait:new</span><span class="params">(duration)</span></span></div><div class="line">    wait.super.new(self, <span class="string">'wait'</span>)</div><div class="line"></div><div class="line">    self.wait_duration = duration</div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> wait.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">if</span> self.done <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">'running'</span> <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait:start</span><span class="params">(context)</span></span></div><div class="line">    context.object.timer:after(self.wait_duration, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self.done = <span class="keyword">true</span> <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">wait:finish</span><span class="params">(status, context)</span></span></div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>Here, like with the Timer decorator, we just set a timer so that after <em>wait_duration</em> seconds this action returns success.<br>Before that happens it will just return running and the sequence won’t be able to move on, which will make the entity do<br>nothing. The tree for the behavior looks like this:</p>
<img src="/images/idle-wander.png" class="center">

<p>We use a sequence to bind everything together. If at any point <em>moveToPoint</em> fails, then <em>wait</em> will not run and the tree<br>will just start over by finding a new point. If the tree succeeds then the entity will have done what we wanted it to do:<br>move to a point and then wait around a bit. After that the tree will just restart and so on…</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    Sequence(<span class="string">'wander'</span>, {</div><div class="line">        findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">        moveToPoint(),</div><div class="line">        wait(<span class="number">5</span>),</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<img src="http://puu.sh/aWCVB/e243d7dddd.gif" class="center">

<h1 id="TK_Practice">TK Practice</h1>
<p>As you can see in that gif there’s a box lying around. To add some more personality to each enemy we’re going to make it so that<br>sometimes they practice their TK on objects around the map. The idea of this game I’m working on is that it’s a school full of people<br>with TK, so it makes sense that sometimes they’d practice it!</p>
<p>To do this we’re going to need two actions: one to check if there’s any object that can be TKed around, and another to do the actual<br>lifting. First, let’s do the one that finds an object:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">anyAround = Action:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">anyAround:new</span><span class="params">(object_types, radius)</span></span></div><div class="line">    anyAround.super.new(self, <span class="string">'anyAround'</span>)</div><div class="line"></div><div class="line">    self.object_types = object_types</div><div class="line">    self.radius = radius</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">anyAround:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> anyAround.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">anyAround:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="comment">-- Query for entities of object_types around a circle of radius radius centered in x, y</span></div><div class="line">    <span class="keyword">local</span> x, y = context.object.body:getPosition()</div><div class="line">    <span class="keyword">local</span> entities = context.object.world:queryAreaCircle(x, y, self.radius, self.object_types)</div><div class="line">    <span class="comment">-- If no entities then fail</span></div><div class="line">    <span class="keyword">if</span> #entities == <span class="number">0</span> <span class="keyword">then</span> </div><div class="line">        <span class="keyword">return</span> <span class="string">'failure'</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="comment">-- Pick a random entity that isn't the entity this tree is attached to,</span></div><div class="line">        <span class="comment">-- set context.any_around_entity to point it and then succeed</span></div><div class="line">        <span class="keyword">local</span> entity = entities[<span class="built_in">math</span>.random(<span class="number">1</span>, #entities)]</div><div class="line">        <span class="keyword">while</span> entity.id == context.object.id <span class="keyword">do</span> entity = entities[<span class="built_in">math</span>.random(<span class="number">1</span>, #entities)] <span class="keyword">end</span></div><div class="line">        context.any_around_entity = entity </div><div class="line">        <span class="keyword">return</span> <span class="string">'success'</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">anyAround:start</span><span class="params">(context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">anyAround:finish</span><span class="params">(status, context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p><em>anyAround</em> is a conditional type of action that will ask a question to the game’s world and return the answer. In this case,<br>the side effect is changing <em>context.any_around_entity</em> to point to some entity of some type around a certain point with some radius.<br>The idea is that before the NPC can move to the object he wants to lift he needs to first find it. Separating finding and moving<br>makes it so that both can be reused later and, as we’ll see, <em>anyAround</em> will be reused a lot.</p>
<p>There’s one problem so far, though. Ideally we want this subtree to look like this:</p>
<img src="/images/tk-practice-ideal.png" class="center">

<p>But <em>anyAround</em> sets <em>context.any_around_entity</em> to point to the entity, while <em>moveToPoint</em> looks for <em>context.move_to_point_target</em><br>to move to the target. There are two solutions to this: either add an additional node that always succeeds and translates<br><em>any_around_entity</em> to <em>move_to_point_target</em>, or change <em>moveToPoint</em> so that it also looks <em>any_around_entity</em> and then translates<br>that into a point it can use. I’ll use the second and this small refactor will be omitted.</p>
<p>Finally, the <em>TKLift</em> action, which does all the lifting work, uses <em>any_around_entity</em> and changes its z velocity:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">tkLift = Action:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tkLift:new</span><span class="params">()</span></span></div><div class="line">    tkLift.super.new(self, <span class="string">'tkLift'</span>)</div><div class="line"></div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tkLift:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> tkLift.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tkLift:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">if</span> self.done <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span> <span class="keyword">end</span></div><div class="line">    <span class="keyword">if</span> context.any_around_entity <span class="keyword">then</span></div><div class="line">        <span class="comment">-- Change z velocity so that the targetted entity goes up a bit</span></div><div class="line">        context.any_around_entity.v_z = -mg.utils.<span class="built_in">math</span>.random(<span class="number">10</span>, <span class="number">30</span>)</div><div class="line">        <span class="keyword">return</span> <span class="string">'running'</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">'failure'</span> <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tkLift:start</span><span class="params">(context)</span></span></div><div class="line">    context.object.tk_charging = <span class="keyword">true</span></div><div class="line">    <span class="comment">-- This action lasts between 0.5 and 1.5 seconds</span></div><div class="line">    context.object.timer:after({<span class="number">0.5</span>, <span class="number">1.5</span>}, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self.done = <span class="keyword">true</span> <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">tkLift:finish</span><span class="params">(status, context)</span></span></div><div class="line">    <span class="comment">-- Clean everything up, including removing the reference to the targetted entity</span></div><div class="line">    <span class="comment">-- from the context. Since Lua's GC uses reference counting to remove its objects</span></div><div class="line">    <span class="comment">-- from memory this is super important!!!</span></div><div class="line">    context.any_around_entity = <span class="keyword">nil</span></div><div class="line">    context.object.tk_charging = <span class="keyword">false</span></div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>And then after that we tie it all to a sequence. And since we want the enemy to do one thing or<br>the other, either try to lift objects or wander around, we use a selector on top of that. The order in which<br>we place each subtree also matters a lot. Suppose we do selector -&gt; wander, lift. The <em>wander</em> sequence rarely<br>fails, which means that the selector would succeed whenever <em>wander</em> succeeded, which means that <em>tkLift</em> would<br>never really be picked. <em>tkLift</em> fails whenever there isn’t a particular object around, which means that placing it before<br>the <em>wander</em> subtree makes more sense.</p>
<img src="/images/tk-practice-wander.png" class="center">

<img src="http://puu.sh/aWNlJ/e24bfbfcde.gif" class="center">

<p>There’s still a problem, though. As you can see in the gif, whenever the NPC finds a box once he’ll be addicted to lifting it.<br>That’s because there are no checks in place to keep this from happening. The <em>anyAround</em> query will always return success after<br>the first time, because there will be a box around, and so the whole lifting sequence will be performed and it will repeat again<br>forever. To prevent this from happening we can either try creating a decorator or performing an additional check by creating<br>another action. I’ll choose to go with the decorator one:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">DontSucceedInARow = Decorator:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DontSucceedInARow:new</span><span class="params">(behavior)</span></span></div><div class="line">    DontSucceedInARow.super.new(self, <span class="string">'DontSucceedInARow'</span>, behavior)</div><div class="line">    </div><div class="line">    self.past_status = <span class="string">'invalid'</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DontSucceedInARow:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> DontSucceedInARow.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DontSucceedInARow:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">local</span> status = self.behavior:update(dt, context)</div><div class="line">    <span class="comment">-- If success now and the last run was successful as well then fail!</span></div><div class="line">    <span class="keyword">if</span> status == <span class="string">'success'</span> <span class="keyword">and</span> self.past_status == <span class="string">'success'</span> <span class="keyword">then</span></div><div class="line">        <span class="comment">-- Dirty hack: since moveToPoint now also reads in context.any_around_entity,</span></div><div class="line">        <span class="comment">-- we remove the reference here to avoid adding a node that does this.</span></div><div class="line">        <span class="comment">-- If this reference isn't removed then the NPC will still be addicted to following</span></div><div class="line">        <span class="comment">-- the same box around, it'll just do never lift the box twice in a row.</span></div><div class="line">        <span class="comment">-- And this can't reference can't be removed in anyAround either because there's</span></div><div class="line">        <span class="comment">-- nowhere to do it there where it won't affect behaviors that might need to use the reference.</span></div><div class="line">        context.any_around_entity = <span class="keyword">nil</span></div><div class="line">        self.past_status = <span class="string">'failure'</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'failure'</span></div><div class="line">    <span class="keyword">else</span> </div><div class="line">        self.past_status = status</div><div class="line">        <span class="keyword">return</span> status </div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DontSucceedInARow:start</span><span class="params">(context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DontSucceedInARow:finish</span><span class="params">(status, context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>Now whenever <em>anyAround</em> succeeds twice in a row a failure will be forced. That failure existing, the tree will be able<br>to move on to try out the <em>wander</em> subtree, which means the NPC won’t get stuck in the same box again.</p>
<img src="/images/dont-succeed.png" class="center">

<img src="http://puu.sh/aWWTs/8a5b52d27c.gif" class="center">

<p>And so the whole tree looks like this:</p>
<img src="/images/tk-lift-wander.png" class="center">

<p>And the code to do that like this:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    Selector(<span class="string">'idle'</span>, {</div><div class="line">        Sequence(<span class="string">'TK practice'</span>, {</div><div class="line">            DontSucceedInARow(anyAround({<span class="string">'Box'</span>}, <span class="number">50</span>)),</div><div class="line">            moveToPoint(),</div><div class="line">            tkLift(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'wander'</span>, {</div><div class="line">            findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">            moveToPoint(),</div><div class="line">            wait(<span class="number">5</span>),</div><div class="line">        })</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<h1 id="Talking_to_Friends">Talking to Friends</h1>
<p>This is the first kinda complex behavior and there are multiple ways of going about doing it. The goal is to get the NPCs to talk to<br>each other somehow. The way I’ll do it is by creating <em>FriendMeetingPoint</em> objects, to which NPCs will be able to attach themselves<br>to and wait around for other NPCs to attach themselves to those points and then they’ll be able to talk. The first step to doing that<br>is finding and moving to one of those <em>FriendMeetingPoints</em>. Similarly to how we move to a box in the <em>tkLift</em> behavior, we can use<br><em>anyAround</em> and <em>moveToPoint</em>:</p>
<img src="/images/talk-friend-1.png">

<p>And this works fine. However, there’s some repetition going on there. The DontSucceedInARow, anyAround -&gt; moveToPoint subtree looks<br>exactly the same in <em>TK practice</em> as it does in <em>friend talk</em>. Luckily, there’s a way of removing this repetition by storing subtrees!</p>
<h1 id="Storing_Subtrees">Storing Subtrees</h1>
<p>Storing a subtree simply means that you’ll take the way in which those nodes are arranged and you’ll store it so you don’t have to<br>type it all again whenever you wanna reuse it. Think of it like a function that you call and that builds that whole subtree with the<br>arguments you pass to it. </p>
<img src="/images/find-and-move-to.png">

<p>And the way to achieve that, at least in Lua, is exactly like thinking of it as a function. We simply create a file that returns a<br>function that returns the built subtree:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(object_types, radius)</span></span></div><div class="line">    <span class="keyword">return</span> Sequence(<span class="string">'findAndMoveTo'</span>, {</div><div class="line">        DontSucceedInARow(anyAround(object_types, radius)),</div><div class="line">        moveToPoint(),</div><div class="line">    })</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>And then to call it:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    Selector(<span class="string">'idle'</span>, {</div><div class="line">        Sequence(<span class="string">'TK practice'</span>, {</div><div class="line">            findAndMoveTo({<span class="string">'Box'</span>}, <span class="number">50</span>),</div><div class="line">            tkLift(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'friend talk'</span>, {</div><div class="line">            findAndMoveTo({<span class="string">'FriendMeetingPoint'</span>}, <span class="number">100</span>),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'wander'</span>, {</div><div class="line">            findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">            moveToPoint(),</div><div class="line">            wait(<span class="number">5</span>),</div><div class="line">        })</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<h1 id="Talking_to_Friends-1">Talking to Friends</h1>
<p>Back to friends, I’ll omit two actions because they’re extremely dependant on how I’ve coded the <em>FriendMeetingPoint</em> entity:<br><em>attachTo</em>, which attaches the NPC to the <em>FriendMeetingPoint</em> entity and <em>anyAroundAttached</em>, which looks for a friendly NPC<br>that is also attached to a <em>FriendMeetingPoint</em> entity. The subtree now looks like this:</p>
<img src="/images/friend-talk-attach.png" class="center">

<p>The <em>WaitUntil</em> decorator waits until the child node returns success before it can return success. This means that once an entity<br>is attached to a <em>FriendMeetingPoint</em>, it’ll stay there until some other NPC comes along to talk to it.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">WaitUntil = Decorator:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaitUntil:new</span><span class="params">(behavior)</span></span></div><div class="line">    WaitUntil.super.new(self, <span class="string">'WaitUntil'</span>, behavior)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaitUntil:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> WaitUntil.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaitUntil:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">local</span> status = self.behavior:update(dt, context)</div><div class="line">    <span class="keyword">if</span> status == <span class="string">'success'</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">'running'</span> <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaitUntil:start</span><span class="params">(context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">WaitUntil:finish</span><span class="params">(status, context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>After this we add one more action before the actual <em>talk</em> action, which is <em>separate</em>. In case two NPCs attach themselves to<br>the same <em>FriendMeetingPoint</em> we want to separate them a bit before they start talking, otherwise it looks a little too weird.<br>The <em>separate</em> action uses the separation steering behavior that the entities in my game have, so it’s pretty simple code wise:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">separate = Action:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">separate:new</span><span class="params">(radius)</span></span></div><div class="line">    separate.super.new(self, <span class="string">'separate'</span>)</div><div class="line"></div><div class="line">    self.radius = radius</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">separate:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> separate.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">separate:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> <span class="string">'success'</span>   </div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">separate:start</span><span class="params">(context)</span></span></div><div class="line">    context.object:separationOn(self.radius)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">separate:finish</span><span class="params">(status, context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>And finally we add the <em>talk</em> action, which contains most of the work:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">talk = Action:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">talk:new</span><span class="params">(talk_duration)</span></span></div><div class="line">    talk.super.new(self, <span class="string">'talk'</span>)</div><div class="line"></div><div class="line">    self.talk_duration = talk_duration</div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">talk:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> talk.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">talk:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">if</span> self.done <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span></div><div class="line">    <span class="keyword">else</span> </div><div class="line">        <span class="keyword">if</span> context.any_around_attached_entity <span class="keyword">then</span></div><div class="line">            context.object:turnTowards(context.any_around_attached_entity)</div><div class="line">        <span class="keyword">end</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'running'</span> </div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">talk:start</span><span class="params">(context)</span></span></div><div class="line">    <span class="comment">-- Timers so that they start talking slightly after they turn towards each other,</span></div><div class="line">    <span class="comment">-- more precisely 0.5 seconds after. Similarly, set a timer so that this entity stops talking</span></div><div class="line">    <span class="comment">-- after the talk duration and so that this node returns success (self.done).</span></div><div class="line">    context.object.timer:after(<span class="number">0.5</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> context.object:setTalking(self.talk_duration - <span class="number">1</span>) <span class="keyword">end</span>)</div><div class="line">    context.object.timer:after(<span class="number">0.5</span> + self.talk_duration - <span class="number">1</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> context.object:stopTalking() <span class="keyword">end</span>)</div><div class="line">    context.object.timer:after(self.talk_duration, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> self.done = <span class="keyword">true</span> <span class="keyword">end</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">talk:finish</span><span class="params">(status, context)</span></span></div><div class="line">    <span class="comment">-- Normal clean up...</span></div><div class="line">    self.done = <span class="keyword">false</span></div><div class="line">    context.any_around_attached_entity = <span class="keyword">nil</span></div><div class="line">    context.object.attached_to = <span class="keyword">nil</span></div><div class="line">    <span class="comment">-- Turn the separation behavior off here!</span></div><div class="line">    context.object:separationOff()</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>With this, NPCs should move around randomly, find boxes and lift them with their TK sometimes, and whenever they get close to<br>a <em>FriendMeetingPoint</em> they’ll go there to try to talk to someone. There’s the possibility they’ll be stuck there forever if<br>no one shows up, but that’s a detail that can be fixed by adding a time limit to the <em>WaitUntil</em> decorator for instance. Other than<br>that we have a working implementation of an idle behavior for a particular NPC of this game. It wasn’t super simple but to me<br>at least it beats the approach I was taking before! (which was just hardcoding everything)</p>
<img src="http://puu.sh/aX9ZD/9fd7b0412a.gif" class="center">

<p>The whole tree now looks like this:</p>
<img src="/images/idle-done.png" class="center">

<p>And the code:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    Selector(<span class="string">'idle'</span>, {</div><div class="line">        Sequence(<span class="string">'TK practice'</span>, {</div><div class="line">            findAndMoveTo({<span class="string">'Box'</span>}, <span class="number">50</span>),</div><div class="line">            tkLift(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'friend talk'</span>, {</div><div class="line">            findAndMoveTo({<span class="string">'FriendMeetingPoint'</span>}, <span class="number">100</span>),</div><div class="line">            attachTo(<span class="string">'FriendMeetingPoint'</span>, <span class="number">10</span>),</div><div class="line">            WaitUntil(anyAroundAttached(<span class="string">'Student'</span>, <span class="string">'FriendMeetingPoint'</span>, <span class="number">80</span>)),</div><div class="line">            separate(<span class="number">10</span>),</div><div class="line">            talk(<span class="number">5</span>),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'wander'</span>, {</div><div class="line">            findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">            moveToPoint(),</div><div class="line">            wait(<span class="number">5</span>),</div><div class="line">        })</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<h1 id="Suspicious">Suspicious</h1>
<p>Now that the idle subtree is done we can move on to the suspicious behavior. This behavior will check to see if the player is around,<br>if it is then it will set the NPC to be suspicious, which will turn him towards the player, change his animation to combat mode<br>and spawn a little question mark above his head. This lasts a few seconds, after which we perform another check to see if the player<br>is still inside the suspicious trigger area, if he is, then we bail out of the sequence and fail, and if he isn’t then we set<br>the NPC back to normal using an unsuspicious action.</p>
<p>The subtree should look like this:</p>
<img src="/images/suspicious.png" class="center">

<p>I’m going to omit the specifis of each behavior since by now you should have a good idea of how I’m coding them and how you’re<br>coding them. If you’re following along and trying this out with your game your tree may look slightly different based on how you’ve<br>coded each behavior, but that just happens, since there are multiple ways of achieving the same thing. In any case, the whole tree<br>should look like this:</p>
<img src="/images/suspicious-tree.png" class="center">

<p>We tie everything up with a selector at the top and by placing the suspicious behavior to the left. We want the tree to first check<br>for any suspicious activity around, and then if that fails, be able to go to idle stuff. The code looks like this:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    Selector(<span class="string">'meleeEnemy'</span>, {</div><div class="line">        Sequence(<span class="string">'suspicious'</span>, {</div><div class="line">            anyAround({<span class="string">'Player'</span>}, <span class="number">150</span>),</div><div class="line">            suspicious(),</div><div class="line">            Inverter(anyAround({<span class="string">'Player'</span>}, <span class="number">150</span>)),</div><div class="line">            unsuspicious(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Selector(<span class="string">'idle'</span>, {</div><div class="line">            Sequence(<span class="string">'TK practice'</span>, {</div><div class="line">                findAndMoveTo({<span class="string">'Box'</span>}, <span class="number">50</span>),</div><div class="line">                tkLift(),</div><div class="line">            }),</div><div class="line"></div><div class="line">            Sequence(<span class="string">'friend talk'</span>, {</div><div class="line">                findAndMoveTo({<span class="string">'FriendMeetingPoint'</span>}, <span class="number">100</span>),</div><div class="line">                attachTo(<span class="string">'FriendMeetingPoint'</span>, <span class="number">10</span>),</div><div class="line">                WaitUntil(anyAroundAttached(<span class="string">'Student'</span>, <span class="string">'FriendMeetingPoint'</span>, <span class="number">80</span>)),</div><div class="line">                separate(<span class="number">10</span>),</div><div class="line">                talk(<span class="number">5</span>),</div><div class="line">            }),</div><div class="line"></div><div class="line">            Sequence(<span class="string">'wander'</span>, {</div><div class="line">                findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">                moveToPoint(),</div><div class="line">                wait(<span class="number">5</span>),</div><div class="line">            })</div><div class="line">        })</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<img src="http://puu.sh/aXhFp/2e471c82db.gif" class="center">

<p>As you can see on that gif though, there’s a problem here. Whenever the player enters the suspicious trigger area (yellow circle),<br>the NPC doesn’t become suspicious immediately. This is because he’s still waiting for the <em>wait</em> action to be finished on the<br>idle subtree, which means that he won’t check the suspicious subtree until it ends. We want it to check this immediately, as soon as<br>it happens, but using a normal selector that won’t be possible.</p>
<h1 id="Active_Selector">Active Selector</h1>
<p>An active selector behaves like a selector, except instead of returning to the node that is still running, it always checks all<br>children. So in our case whenever <em>wait</em> returns ‘running’, on the next frame, instead of just going directly to that node and<br>running it again, it will run the suspicious subtree first, see if it returned running or failure, and then move on to the idle<br>subtree where it will pick up from the running <em>wait</em> node. If suspicious succeeds, however, since it behaves like a selector it<br>won’t run the idle subtree.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">ActiveSelector = Behavior:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ActiveSelector:new</span><span class="params">(name, behaviors)</span></span></div><div class="line">    ActiveSelector.super.new(self)</div><div class="line">    self.name = name</div><div class="line">    self.behaviors = behaviors</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ActiveSelector:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> ActiveSelector.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ActiveSelector:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="comment">-- Logic is exactly the same as a normal selector, except instead </span></div><div class="line">    <span class="comment">-- of keeping track of which behavior we're in by using current_behavior, </span></div><div class="line">    <span class="comment">-- we just don't do it at all and go through them all every frame.</span></div><div class="line">    <span class="keyword">for</span> _, behavior <span class="keyword">in</span> <span class="built_in">ipairs</span>(self.behaviors) <span class="keyword">do</span></div><div class="line">        <span class="keyword">local</span> status = behavior:update(dt, context)</div><div class="line">        <span class="keyword">if</span> status ~= <span class="string">'failure'</span> <span class="keyword">then</span> <span class="keyword">return</span> status <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'failure'</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ActiveSelector:start</span><span class="params">(context)</span></span></div><div class="line"></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ActiveSelector:finish</span><span class="params">(status, context)</span></span></div><div class="line">    </div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>And now it should behave accordingly because it will always first check the suspicious subtree (since it’s first on the list). Note<br>that this is, in a way, parallelism. Although isn’t real because it’s doing each in sequence, for the purposes of the tree it is real,<br>since what matters is what happens over multiple frames, and this makes it so that things happen in one frame simultaneously. For the<br>threatened subtree I’ll introduce yet another node called the Parallel, which does something similar to the active selector but has<br>different success/failure logic.</p>
<img src="http://puu.sh/aXhxg/6dc2cdca41.gif" class="center">

<h1 id="Threatened">Threatened</h1>
<p>For the threatened behavior the same active selector logic will apply. We need the NPC to be threatened immediately when the Player<br>comes too close. Similarly to <em>suspicious</em>, we’ll use <em>anyAround</em> for this:</p>
<img src="/images/threatened-1.png" class="center">

<img src="http://puu.sh/aXkZB/58be60cd92.gif" class="center">

<p>Now what we wanna do is make it so that when the NPC is threatened, it chases the player around and tries to hit him if it gets close<br>enough. One way of doing that is, after the <em>threatened</em> node, add a subtree that repeatedly chases and tries to hit the player while<br>doing so:</p>
<img src="/images/attack.png" class="center">

<p><em>repeatUntilFail</em> will make it so that this whole sequence of checking to see if the player is still close and then chasing/punching<br>is repeated forever, which means the NPC will chase the player until he distances himself enough. After that, the only node we<br>don’t really know anything about (assuming the implementation of <em>chase</em> and <em>meleeAttack</em>) is the Parallel one.</p>
<p>The implementation of the parallel node is probably one of the most complex ones, but it’s similar to the active selector in the sense<br>that it always goes through all nodes. The only difference is that on top of receiving behaviors as arguments it can also receive<br>failure and success policies. A failure policy defines when the parallel node will fail, same for the success one. Both types of<br>policies have two possible values: ‘one’ or ‘all’. An ‘one’ failure policy means that the parallel node will fail whenever one of its<br>nodes fail. An ‘all’ success policy means that the parallel node will succeed only when all of its children succeed, and so on… </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">Parallel = Behavior:extend()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parallel:new</span><span class="params">(name, success_policy, failure_policy, behaviors)</span></span></div><div class="line">    Parallel.super.new(self)</div><div class="line">    self.name = name</div><div class="line">    self.success_policy = success_policy</div><div class="line">    self.failure_policy = failure_policy</div><div class="line">    self.behaviors = behaviors</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parallel:update</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">return</span> Parallel.super.update(self, dt, context)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parallel:run</span><span class="params">(dt, context)</span></span></div><div class="line">    <span class="keyword">local</span> success_count, failure_count = <span class="number">0</span>, <span class="number">0</span> </div><div class="line">    <span class="keyword">for</span> _, behavior <span class="keyword">in</span> <span class="built_in">ipairs</span>(self.behaviors) <span class="keyword">do</span></div><div class="line">        <span class="keyword">local</span> status = <span class="keyword">nil</span></div><div class="line">        status = behavior:update(dt, context)</div><div class="line">            </div><div class="line">        <span class="keyword">if</span> status == <span class="string">'success'</span> <span class="keyword">then</span></div><div class="line">            success_count = success_count + <span class="number">1</span></div><div class="line">            behavior:finish(status, context)</div><div class="line">            <span class="comment">-- Got one success and the success policy only requires one, so succeed</span></div><div class="line">            <span class="comment">-- same for failure in the next if statement.</span></div><div class="line">            <span class="keyword">if</span> self.success_policy == <span class="string">'one'</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span> <span class="keyword">end</span></div><div class="line">        <span class="keyword">end</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> status == <span class="string">'failure'</span> <span class="keyword">then</span></div><div class="line">            failure_count = failure_count + <span class="number">1</span></div><div class="line">            behavior:finish(status, context)</div><div class="line">            <span class="keyword">if</span> self.failure_policy == <span class="string">'one'</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'failure'</span> <span class="keyword">end</span></div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"></div><div class="line">    <span class="comment">-- Has been through all behaviors, the failure/success policy is 'all' and the number of</span></div><div class="line">    <span class="comment">-- behaviors matches the failure/success count? Then fail/succeed!</span></div><div class="line">    <span class="keyword">if</span> self.failure_policy == <span class="string">'all'</span> <span class="keyword">and</span> failure_count == #self.behaviors <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'failure'</span> <span class="keyword">end</span></div><div class="line">    <span class="keyword">if</span> self.success_policy == <span class="string">'all'</span> <span class="keyword">and</span> success_count == #self.behaviors <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">'success'</span> <span class="keyword">end</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'running'</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parallel:start</span><span class="params">(context)</span></span></div><div class="line">    </div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Parallel:finish</span><span class="params">(status, context)</span></span></div><div class="line">    <span class="comment">-- If the parallel node is done, finish all currently running behaviors so that </span></div><div class="line">    <span class="comment">-- the next time the node is run it starts over instead of continuing the previous run.</span></div><div class="line">    <span class="keyword">for</span> _, behavior <span class="keyword">in</span> <span class="built_in">ipairs</span>(self.behaviors) <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> behavior.status == <span class="string">'running'</span> <span class="keyword">then</span></div><div class="line">            behavior:finish(status, context)</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>For the attack subtree we used (‘all’, ‘all’), which means that we want it to fail or succeed whenever both behaviors<br>fail or succeed, which is rare. <em>chase</em> always succeeds. <em>anyAround</em> can fail if the player is far away enough from the NPC.<br><em>meleeAttack</em> always succeeds.<br>Whenever they all succeed, the parallel node will succeed, which means the sequence will succeed, which will return success to<br><em>repeatUntilFail</em>, meaning that the whole subtree will be repeated again. The only way out of this subtree is if the first<br><em>anyAround</em> outside of the parallel node fails, which is the intended behavior.</p>
<p>And with that we have a working attacking enemy! The code for the whole tree now looks like this:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">self.behavior_tree = Root(self,</div><div class="line">    ActiveSelector(<span class="string">'meleeEnemy'</span>, {</div><div class="line">        Sequence(<span class="string">'attack'</span>, {</div><div class="line">            anyAround({<span class="string">'Player'</span>}, <span class="number">75</span>),</div><div class="line">            threatened(),</div><div class="line">            RepeatUntilFail(Sequence(<span class="string">'chase'</span>, {</div><div class="line">                anyAround({<span class="string">'Player'</span>}, <span class="number">75</span>),</div><div class="line">                Parallel(<span class="string">'chaseAttack'</span>, <span class="string">'all'</span>, <span class="string">'all'</span>, {</div><div class="line">                    chase(),</div><div class="line">                    Sequence(<span class="string">'attack'</span>, {</div><div class="line">                        anyAround({<span class="string">'Player'</span>}, <span class="number">30</span>),</div><div class="line">                        meleeAttack(),</div><div class="line">                    }),</div><div class="line">                }),</div><div class="line">            })),</div><div class="line">            Inverter(anyAround({<span class="string">'Player'</span>}, <span class="number">75</span>)),</div><div class="line">            unthreatened(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Sequence(<span class="string">'suspicious'</span>, {</div><div class="line">            anyAround({<span class="string">'Player'</span>}, <span class="number">150</span>),</div><div class="line">            suspicious(),</div><div class="line">            Inverter(anyAround({<span class="string">'Player'</span>}, <span class="number">150</span>)),</div><div class="line">            unsuspicious(),</div><div class="line">        }),</div><div class="line"></div><div class="line">        Selector(<span class="string">'idle'</span>, {</div><div class="line">            Sequence(<span class="string">'TK practice'</span>, {</div><div class="line">                findAndMoveTo({<span class="string">'Box'</span>}, <span class="number">50</span>),</div><div class="line">                tkLift(),</div><div class="line">            }),</div><div class="line"></div><div class="line">            Sequence(<span class="string">'friend talk'</span>, {</div><div class="line">                findAndMoveTo({<span class="string">'FriendMeetingPoint'</span>}, <span class="number">100</span>),</div><div class="line">                attachTo(<span class="string">'FriendMeetingPoint'</span>, <span class="number">10</span>),</div><div class="line">                WaitUntil(anyAroundAttached(<span class="string">'Student'</span>, <span class="string">'FriendMeetingPoint'</span>, <span class="number">80</span>)),</div><div class="line">                separate(<span class="number">10</span>),</div><div class="line">                talk(<span class="number">5</span>),</div><div class="line">            }),</div><div class="line"></div><div class="line">            Sequence(<span class="string">'wander'</span>, {</div><div class="line">                findWanderPoint(self.x, self.y, <span class="number">100</span>),</div><div class="line">                moveToPoint(),</div><div class="line">                wait(<span class="number">5</span>),</div><div class="line">            })</div><div class="line">        })</div><div class="line">    })</div><div class="line">)</div><div class="line">...</div></pre></td></tr></table></figure>

<p>And the final tree looks like this:</p>
<img src="/images/final-tree.png" class="center">

<img src="http://puu.sh/aXmA4/7dd6d91de2.gif" class="center">

<h1 id="END">END</h1>
<p>And that’s it! If you’ve followed through all this, even if just reading the explanations and code, you should have a nice idea of<br>what behavior trees can do and how they do it. Hopefully this helped you in ways that I wanted to be helped when I was trying to<br>understand all this. There are tons of issues with the way I’m doing it and there are tons of resources that go beyond what my<br>implementation does, but since my game isn’t really memory nor performance intensive I can get away with the simple solution. The<br>resources on the first paragraph of the first part mostly cover these issues.</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/ai/">ai</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://psychoky.me/2014/08/17/behavior-trees-number-2/" data-title="Behavior Trees #2 | My Little Peaceful Grove of Regret and Shame" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2014/08/16/behavior-trees-number-1/"  title="Behavior Trees #1">
 <strong>NEXT:</strong><br/> 
 <span>Behavior Trees #1
</span>
</a>
</div>

</nav>

	


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Wander"><span class="toc-number">1.</span> <span class="toc-text">Wander</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TK_Practice"><span class="toc-number">2.</span> <span class="toc-text">TK Practice</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Talking_to_Friends"><span class="toc-number">3.</span> <span class="toc-text">Talking to Friends</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Storing_Subtrees"><span class="toc-number">4.</span> <span class="toc-text">Storing Subtrees</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Talking_to_Friends-1"><span class="toc-number">5.</span> <span class="toc-text">Talking to Friends</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Suspicious"><span class="toc-number">6.</span> <span class="toc-text">Suspicious</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Active_Selector"><span class="toc-number">7.</span> <span class="toc-text">Active Selector</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Threatened"><span class="toc-number">8.</span> <span class="toc-text">Threatened</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#END"><span class="toc-number">9.</span> <span class="toc-text">END</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/ai/" title="ai">ai<sup>2</sup></a></li>
		
			<li><a href="/tags/code-organization/" title="code organization">code organization<sup>1</sup></a></li>
		
			<li><a href="/tags/lua/" title="lua">lua<sup>1</sup></a></li>
		
			<li><a href="/tags/procedural/" title="procedural">procedural<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		<a href="https://twitter.com/adnzzzzZ" target="_blank" title="twitter"></a>
		
		
		<a href="https://github.com/adonaac" target="_blank" title="github"></a>
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/zhyu/yaht" target="_blank" title="YAHT">YAHT</a> © 2015 
		
		<a href="http://psychoky.me" target="_blank" title="adnzzzzZ">adnzzzzZ</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.navbar').click(function(){
      $('header nav').toggleClass('shownav');
    });
    var myWidth = 0;
    function getSize(){
      if( typeof( window.innerWidth ) == 'number' ) {
        myWidth = window.innerWidth;
      } else if( document.documentElement && document.documentElement.clientWidth) {
        myWidth = document.documentElement.clientWidth;
      };
    };
    var m = $('#main'),
    a = $('#asidepart'),
    c = $('.closeaside'),
    o = $('.openaside');
    $(window).resize(function(){
      getSize();
      if (myWidth >= 1024) {
        $('header nav').removeClass('shownav');
      }else
      {
        m.removeClass('moveMain');
        a.css('display', 'block').removeClass('fadeOut');
        o.css('display', 'none');
        
            $('#toc.toc-aside').css('display', 'none');
          
      }
    });
    c.click(function(){
      a.addClass('fadeOut').css('display', 'none');
      o.css('display', 'block').addClass('fadeIn');
      m.addClass('moveMain');
    });
    o.click(function(){
      o.css('display', 'none').removeClass('beforeFadeIn');
      a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
      m.removeClass('moveMain');
    });
    $(window).scroll(function(){
      o.css("top",Math.max(80,260-$(this).scrollTop()));
    });
  });
</script>

  <script type="text/javascript">
    $(document).ready(function(){
      var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
      if(ai.length>0){
        ai.wrap('<div class="video-container" />');
      };
      if(ae.length>0){
        ae.wrap('<div class="video-container" />');
      };
      if(ah.length==0){
        t.css('display','none');
      }else{
        c.click(function(){
          ta.css('display', 'block').addClass('fadeIn');
        });
        o.click(function(){
          ta.css('display', 'none');
        });
        $(window).scroll(function(){
          ta.css("top",Math.max(140,320-$(this).scrollTop()));
        });
      };
    });
  </script>


  <script type="text/javascript">
    $(document).ready(function(){
      var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
      var html = [
        '<a href="#" class="overlay" id="qrcode"></a>',
        '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
        '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
        '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
        '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
        '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
        '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
        '<span title="Share to"></span>'
        ].join('');
        $this.append(html);
        $('.article-share-qrcode').click(function(){
          var imgSrc = $('#qrcode-pic').attr('data-src');
          $('#qrcode-pic').attr('src', imgSrc);
          $('#qrcode-pic').load(function(){
            $('.qrcode strong').text(' ');
          });
        });
    });
  </script>


  
  






  <div id="back-to-top">
    <a title="Back to Top"><img src="/img/scrollup.png"/></a>
  </div>
  <script src="/js/back_to_top.js"></script>



  </body>
</html>
