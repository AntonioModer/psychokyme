
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Tilemap to Collision Geometry | My Little Peaceful Grove of Regret and Shame</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="adnzzzzZ">
    
    <meta name="description" content="This post explains an algorithm for turning a tilemap into level geometry">
    
    
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="adnzzzzZ" />
    <meta name="twitter:title" content="Tilemap to Collision Geometry | My Little Peaceful Grove of Regret and Shame" />
      
    
    
    <link rel="alternate" href="/atom.xml" title="My Little Peaceful Grove of Regret and Shame" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/style.css" type="text/css">

</head>

  <body>
    <header>
      <div>
		
            <!--
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="My Little Peaceful Grove of Regret and Shame" title="My Little Peaceful Grove of Regret and Shame"/></a>
			</div>
            -->
			
            
            <div id="imglogo">
                <div class="author"></div>
            </div>
            
            <!--
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="My Little Peaceful Grove of Regret and Shame">My Little Peaceful Grove of Regret and Shame</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
            -->
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:psychoky.me">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/01/09/tilemap-to-collision-geometry/" title="Tilemap to Collision Geometry" itemprop="url">Tilemap to Collision Geometry</a>
  </h1>
  <p class="article-author">by
    
      <a href="http://psychoky.me" title="adnzzzzZ">adnzzzzZ</a>
    </p>
  <p class="article-time">
    <time datetime="2015-01-09T07:55:15.000Z" itemprop="datePublished">Jan 9 2015</time>
    Updated:<time datetime="2015-01-09T09:06:31.000Z" itemprop="dateModified">Jan 9 2015</time>
    
  </p>
</header>

	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Collision_Map"><span class="toc-number">1.</span> <span class="toc-text">Collision Map</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Edge_Creation"><span class="toc-number">2.</span> <span class="toc-text">Edge Creation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Edge_Deletion"><span class="toc-number">3.</span> <span class="toc-text">Edge Deletion</span></a></li></ol>
		</div>
		
		<p>This post explains an algorithm for turning a tilemap into level geometry<a id="more"></a>.</p>
<h2 id="Collision_Map">Collision Map</h2>
<p>Generate a collision map from your tilemap. This should be a 2D array, like the tilemap, that has one value for a solid tile and another for an empty tile, like 1 and 0.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">grid = {</div><div class="line">    {<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>},</div><div class="line">    {<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>},</div><div class="line">    {<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>},</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Edge_Creation">Edge Creation</h2>
<p>For each solid tile in the tilemap (tile that has a 1 value), create all of its 4 edges. An edge can be a simple table/struct of two points, the start and the end of the edge. For this algorithm I created the edges with the points starting in the bottom left corning and going in a clockwise order:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> edges = {}</div><div class="line"><span class="keyword">local</span> mx, my = tilemap.tile_width, tilemap.tile_height</div><div class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #grid <span class="keyword">do</span></div><div class="line">    <span class="keyword">for</span> j = <span class="number">1</span>, #grid[i] <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> grid[i][j] ~= <span class="number">0</span> <span class="keyword">then</span></div><div class="line">            <span class="keyword">local</span> x, y = mx*(j-<span class="number">1</span>) + mx/<span class="number">2</span>, my*(i-<span class="number">1</span>) + my/<span class="number">2</span></div><div class="line">            <span class="keyword">local</span> v0 = {x = x - mx/<span class="number">2</span>, y = y + my/<span class="number">2</span>}</div><div class="line">            <span class="keyword">local</span> v1 = {x = x - mx/<span class="number">2</span>, y = y - my/<span class="number">2</span>}</div><div class="line">            <span class="keyword">local</span> v2 = {x = x + mx/<span class="number">2</span>, y = y - my/<span class="number">2</span>}</div><div class="line">            <span class="keyword">local</span> v3 = {x = x + mx/<span class="number">2</span>, y = y + my/<span class="number">2</span>}</div><div class="line">            <span class="built_in">table</span>.insert(edges, {v0, v1})</div><div class="line">            <span class="built_in">table</span>.insert(edges, {v1, v2})</div><div class="line">            <span class="built_in">table</span>.insert(edges, {v2, v3})</div><div class="line">            <span class="built_in">table</span>.insert(edges, {v3, v0})</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<h2 id="Edge_Deletion">Edge Deletion</h2>
<p>Now you should have a list of all edges for all tiles that are supposed to be solids in the level. We proceed by deleting all instances of all edges that appear more than once, meaning that the only remaining edges are the outer ones that define the shape, since inner edges that are shared by multiple tiles can only appear twice, and if they appear twice they will both be deleted:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> marked_for_deletion = {}</div><div class="line"><span class="keyword">for</span> i, e1 <span class="keyword">in</span> <span class="built_in">ipairs</span>(edges) <span class="keyword">do</span></div><div class="line">    <span class="keyword">for</span> j, e2 <span class="keyword">in</span> <span class="built_in">ipairs</span>(edges) <span class="keyword">do</span></div><div class="line">        <span class="keyword">if</span> isEdgeEqual(e1, e2) <span class="keyword">then</span></div><div class="line">            <span class="built_in">table</span>.insert(marked_for_deletion, i)</div><div class="line">            <span class="built_in">table</span>.insert(marked_for_deletion, j)</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line">marked_for_deletion = self.fg.fn.unique(marked_for_deletion)</div><div class="line"><span class="built_in">table</span>.sort(marked_for_deletion, <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span> <span class="keyword">return</span> a &lt; b <span class="keyword">end</span>)</div><div class="line"><span class="keyword">for</span> i = #marked_for_deletion, <span class="number">1</span>, -<span class="number">1</span> <span class="keyword">do</span> <span class="built_in">table</span>.remove(edges, marked_for_deletion[i]) <span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>One important function to create here is the <em>isEdgeEqual</em> one. Two edges are equal in this instance if the points (vx, vy) and (vw, wu) appear inversed in both edges, since for each edge that is shared by two tiles it always happens that for one tile the edge is defined in one direction and for the other it is defined in the opposite, as the figure shows:</p>
<img src="/images/tile-edge.png" class="center">

<p>Another thing to note is that equality is defined by the distance between points being lower than some value, and not based on actual equality:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> isEdgeEqual = <span class="function"><span class="keyword">function</span><span class="params">(e1, e2)</span></span></div><div class="line">    <span class="keyword">local</span> d1 = (e1[<span class="number">1</span>].x - e2[<span class="number">2</span>].x)*(e1[<span class="number">1</span>].x - e2[<span class="number">2</span>].x) + (e1[<span class="number">1</span>].y - e2[<span class="number">2</span>].y)*(e1[<span class="number">1</span>].y - e2[<span class="number">2</span>].y)</div><div class="line">    <span class="keyword">local</span> d2 = (e2[<span class="number">1</span>].x - e1[<span class="number">2</span>].x)*(e2[<span class="number">1</span>].x - e1[<span class="number">2</span>].x) + (e2[<span class="number">1</span>].y - e1[<span class="number">2</span>].y)*(e2[<span class="number">1</span>].y - e1[<span class="number">2</span>].y)</div><div class="line">    <span class="keyword">if</span> d1 &lt; <span class="number">0.25</span> <span class="keyword">and</span> d2 &lt; <span class="number">0.25</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="keyword">true</span> <span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>

<p>After this we should proceed to deleting edges that are redundant. Right now the following shape looks like this, where each discontinuity is the start or end of an edge:</p>
<img src="/images/tile-disc.png" class="center">

<p>If a line could be a single edge instead of three (like the top or bottom of that rectangle), then we should delete those extra edges and merge them together. To do this we go through all edges</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/geometry/">geometry</a>
  </div>




<div class="article-share" id="share">

  <div data-url="http://psychoky.me/2015/01/09/tilemap-to-collision-geometry/" data-title="Tilemap to Collision Geometry | My Little Peaceful Grove of Regret and Shame" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 

<div class="next">
<a href="/2014/08/17/behavior-trees-number-2/"  title="Behavior Trees #2">
 <strong>NEXT:</strong><br/> 
 <span>Behavior Trees #2
</span>
</a>
</div>

</nav>


	

<section class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Collision_Map"><span class="toc-number">1.</span> <span class="toc-text">Collision Map</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Edge_Creation"><span class="toc-number">2.</span> <span class="toc-text">Edge Creation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Edge_Deletion"><span class="toc-number">3.</span> <span class="toc-text">Edge Deletion</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  

  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/ai/" title="ai">ai<sup>2</sup></a></li>
		
			<li><a href="/tags/code-organization/" title="code organization">code organization<sup>1</sup></a></li>
		
			<li><a href="/tags/geometry/" title="geometry">geometry<sup>1</sup></a></li>
		
			<li><a href="/tags/lua/" title="lua">lua<sup>1</sup></a></li>
		
			<li><a href="/tags/procedural/" title="procedural">procedural<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font" class="clearfix">
		
		
		<a href="https://twitter.com/adnzzzzZ" target="_blank" title="twitter"></a>
		
		
		<a href="https://github.com/adonaac" target="_blank" title="github"></a>
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/zhyu/yaht" target="_blank" title="YAHT">YAHT</a> © 2015 
		
		<a href="http://psychoky.me" target="_blank" title="adnzzzzZ">adnzzzzZ</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.navbar').click(function(){
      $('header nav').toggleClass('shownav');
    });
    var myWidth = 0;
    function getSize(){
      if( typeof( window.innerWidth ) == 'number' ) {
        myWidth = window.innerWidth;
      } else if( document.documentElement && document.documentElement.clientWidth) {
        myWidth = document.documentElement.clientWidth;
      };
    };
    var m = $('#main'),
    a = $('#asidepart'),
    c = $('.closeaside'),
    o = $('.openaside');
    $(window).resize(function(){
      getSize();
      if (myWidth >= 1024) {
        $('header nav').removeClass('shownav');
      }else
      {
        m.removeClass('moveMain');
        a.css('display', 'block').removeClass('fadeOut');
        o.css('display', 'none');
        
            $('#toc.toc-aside').css('display', 'none');
          
      }
    });
    c.click(function(){
      a.addClass('fadeOut').css('display', 'none');
      o.css('display', 'block').addClass('fadeIn');
      m.addClass('moveMain');
    });
    o.click(function(){
      o.css('display', 'none').removeClass('beforeFadeIn');
      a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
      m.removeClass('moveMain');
    });
    $(window).scroll(function(){
      o.css("top",Math.max(80,260-$(this).scrollTop()));
    });
  });
</script>

  <script type="text/javascript">
    $(document).ready(function(){
      var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
      if(ai.length>0){
        ai.wrap('<div class="video-container" />');
      };
      if(ae.length>0){
        ae.wrap('<div class="video-container" />');
      };
      if(ah.length==0){
        t.css('display','none');
      }else{
        c.click(function(){
          ta.css('display', 'block').addClass('fadeIn');
        });
        o.click(function(){
          ta.css('display', 'none');
        });
        $(window).scroll(function(){
          ta.css("top",Math.max(140,320-$(this).scrollTop()));
        });
      };
    });
  </script>


  <script type="text/javascript">
    $(document).ready(function(){
      var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
      var html = [
        '<a href="#" class="overlay" id="qrcode"></a>',
        '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
        '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
        '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
        '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
        '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
        '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
        '<span title="Share to"></span>'
        ].join('');
        $this.append(html);
        $('.article-share-qrcode').click(function(){
          var imgSrc = $('#qrcode-pic').attr('data-src');
          $('#qrcode-pic').attr('src', imgSrc);
          $('#qrcode-pic').load(function(){
            $('.qrcode strong').text(' ');
          });
        });
    });
  </script>


  
  
    <script type="text/javascript">
      
          var disqus_shortname = 'mylittlepeacefulgroveofregretandshame';
      
      (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }());
    </script>
  






  <div id="back-to-top">
    <a title="Back to Top"><img src="/img/scrollup.png"/></a>
  </div>
  <script src="/js/back_to_top.js"></script>



  </body>
</html>
